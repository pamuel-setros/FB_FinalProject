<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cleveland Browns 12% Rule Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body{font-family:Inter,Segoe UI,Helvetica,Arial;background:#f5f1e8;margin:0;padding:24px;color:#333}
    .container{max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px;padding:16px;background:linear-gradient(135deg,#311C15,#1a0e09);border-radius:8px;color:white;box-shadow:0 6px 18px rgba(49,28,21,0.2)}
    h1{font-size:24px;margin:0;color:#FF6600;font-weight:700}
    .small{color:#999;font-size:13px}
    header .small{color:#ddd}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .card{background:white;border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(49,28,21,0.08);border-left:4px solid #FF6600}
    .stat{font-size:28px;font-weight:700;color:#311C15}
    .description{font-size:12px;color:#666;line-height:1.5;margin-top:12px;padding-top:8px;border-top:1px solid #eee}
    #table-wrap{overflow:auto}
    footer{margin-top:18px;color:#999;font-size:13px;text-align:center;padding:16px;background:#311C15;color:#FF6600;border-radius:6px}
    .error{color:#8B0000;padding:12px;background:#ffe6e6;border-radius:4px;border-left:4px solid #8B0000}
    .loading{color:#999;padding:12px}
    .summary{background:#FFF3E0;border-left:4px solid #FF6600;padding:16px;border-radius:4px;margin-bottom:24px;box-shadow:0 2px 8px rgba(255,102,0,0.1)}
    .summary h2{margin:0 0 12px 0;color:#311C15;font-size:16px;font-weight:700}
    .summary p{margin:6px 0;font-size:14px;color:#333;line-height:1.6}
    .summary a{color:#FF6600;text-decoration:none;font-weight:600}
    .summary a:hover{text-decoration:underline}
    .week-navigator{background:linear-gradient(135deg,#311C15,#4a2c1d);color:white;padding:24px;border-radius:8px;margin-bottom:24px;text-align:center;box-shadow:0 6px 18px rgba(49,28,21,0.15)}
    .week-display{font-size:48px;font-weight:700;margin:16px 0;animation:pulse 0.6s ease-in-out;color:#FF6600}
    .week-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin:16px 0}
    .week-stat{background:rgba(255,102,0,0.1);padding:12px;border-radius:6px;font-size:13px;backdrop-filter:blur(10px);border:1px solid rgba(255,102,0,0.2)}
    .week-stat strong{display:block;font-size:18px;margin-bottom:4px;color:#FF6600}
    .week-controls{display:flex;justify-content:center;gap:12px;margin:16px 0;flex-wrap:wrap}
    .nav-btn{background:#FF6600;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;transition:all 0.2s;font-size:14px;box-shadow:0 2px 6px rgba(255,102,0,0.3)}
    .nav-btn:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(255,102,0,0.4);background:#e55a00}
    .nav-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .week-slider{width:100%;max-width:400px;margin:0 auto;accent-color:#FF6600}
    @keyframes slideInLeft {from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
    .week-info > div{animation:slideInLeft 0.4s ease-out}
    @keyframes slideIn {from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse {0%,100%{box-shadow:0 6px 18px rgba(49,28,21,0.08)}50%{box-shadow:0 10px 28px rgba(49,28,21,0.15)}}
    .card{animation:slideIn 0.5s ease-out;transition:all 0.3s ease}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(49,28,21,0.15);cursor:pointer}
    .stat-card{position:relative}
    .stat-card::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,transparent,rgba(255,102,0,0.05));border-radius:8px;pointer-events:none}
    table tbody tr:hover{background-color:#fff9f0 !important}
    table tbody tr td{padding:8px}
    table thead th{background:#311C15;color:#FF6600;padding:10px;font-weight:600;text-align:left}
    .filter-btn{background:#FF6600;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:12px;margin:8px 4px 0 0;transition:all 0.2s;font-weight:600}
    .filter-btn:hover{background:#e55a00;transform:scale(1.05);box-shadow:0 2px 6px rgba(255,102,0,0.3)}
    .filter-btn.active{background:#311C15;box-shadow:0 0 8px rgba(49,28,21,0.4)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Cleveland Browns 12% Rule Dashboard</h1>
        <div class="small">Data source: `noisy_12p_rule.csv` — served via Live Server</div>
        <div style="margin-top:12px;padding:12px;background:rgba(255,255,255,0.1);border-radius:4px;font-size:13px;color:#ddd;font-family:monospace;line-height:1.6;">
          <strong style="color:#FF6600;">The 12% Rule Formula:</strong><br>
          (Sacks + Penalties + Drops + Turnovers) ÷ Total Plays ≤ 12%
        </div>
      </div>
    </header>

    <div id="status" class="loading">Loading data...</div>

    <div id="week-navigator" class="week-navigator" style="display:none;">
      <h2 style="margin:0 0 8px 0;font-size:18px;">Browse Games Week by Week</h2>
      <div class="week-display">Week <span id="current-week">1</span></div>
      <div class="week-info">
        <div class="week-stat">
          Opponent<br/>
          <strong id="week-opponent">—</strong>
        </div>
        <div class="week-stat">
          Result<br/>
          <strong id="week-result" style="font-size:20px">—</strong>
        </div>
        <div class="week-stat">
          Browns 12%<br/>
          <strong id="week-browns-12">—</strong>
        </div>
        <div class="week-stat">
          Opp 12%<br/>
          <strong id="week-opp-12">—</strong>
        </div>
        <div class="week-stat">
          Rule Prediction<br/>
          <strong id="week-prediction">—</strong>
        </div>
        <div class="week-stat">
          Status<br/>
          <strong id="week-status" style="font-size:16px">—</strong>
        </div>
      </div>
      <div class="week-controls">
        <button class="nav-btn" onclick="previousWeek()">← Previous</button>
        <input type="range" id="week-slider" class="week-slider" min="1" max="17" value="1" oninput="goToWeek(this.value)">
        <button class="nav-btn" onclick="nextWeek()">Next →</button>
      </div>
    </div>

    <div id="summary-section" class="summary" style="display:none;">
      <h2>Executive Summary</h2>
      <p id="summary-text">Loading analysis...</p>
    </div>

    <div class="grid" id="stats-row" style="display:none;">
      <div class="card stat-card">
        <div class="small">Total Games</div>
        <div id="total-games" class="stat">—</div>
      </div>
      <div class="card stat-card">
        <div class="small">Rule Valid</div>
        <div id="rule-valid" class="stat">—</div>
      </div>
      <div class="card stat-card">
        <div class="small">Rule Invalid</div>
        <div id="rule-invalid" class="stat">—</div>
      </div>
      <div class="card stat-card">
        <div class="small">Rule Accuracy</div>
        <div id="rule-accuracy" class="stat">—</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;display:none;" id="charts-grid">
      <div class="card">
        <div class="small">12% Rule Validity: Browns 12% vs Opp 12%</div>
        <div id="scatter" style="height:360px"></div>
        <div class="description">This scatter plot shows each game's rule prediction (lower 12% = win) versus actual outcome. <strong>Green circles (✓)</strong> indicate games where the 12% rule correctly predicted the outcome. <strong>Red X's (✗)</strong> show predictions that missed. The diagonal line represents equal scores.</div>
      </div>

      <div class="card">
        <div class="small">Rule Accuracy Breakdown</div>
        <div id="validity" style="height:360px"></div>
        <div class="description">A donut chart displaying the split between valid and invalid predictions. This provides a quick visual of overall rule effectiveness. The percentage shown indicates how often the 12% rule successfully predicted game outcomes in the 2024 season.</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;display:none;" id="charts-grid2">
      <div class="card">
        <div class="small">Weekly Comparison — Scores (rounded)</div>
        <div id="weekly" style="height:360px"></div>
        <div class="description">Grouped bar chart comparing Browns and opponent 12% scores across all 17 games. Taller bars indicate more critical errors. Notice the Browns' variability throughout the season and how their performance compared week-to-week against opponents.</div>
      </div>

      <div class="card">
        <div class="small">Distribution — Browns 12% by Outcome</div>
        <div id="distribution" style="height:360px"></div>
        <div class="description">Histograms overlaying Browns' 12% scores for wins (green) versus losses (red). If the 12% rule is effective, win scores should cluster lower and loss scores higher. This visualization helps assess the rule's separability of outcomes.</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;display:none;" id="winning-stats-grid">
      <div class="card">
        <div class="small">Performance Comparison: Wins vs Losses</div>
        <div id="winning-stats" style="height:360px"></div>
        <div class="description">This grouped bar chart compares average critical error statistics between games the Browns won and games they lost. Notice how sacks and turnovers spike dramatically in losses, while penalty counts remain consistent. This visualization demonstrates the impact of defensive pressures on game outcomes. It is also interesting that the Browns had more penalties when we won. Could that mean we played harder?</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;display:none;" id="cleanliness-grid">
      <div class="card">
        <div class="small">Play Cleanliness: Relative Performance vs Opponent</div>
        <div id="cleanliness-chart" style="height:360px"></div>
        <div class="description">This visualization compares the Browns' play "cleanliness" relative to their opponents using the 12% Rule metric. Games where the Browns had a lower 12% score (cleaner play) versus their opponent are compared against games where the Browns had a higher 12% score (dirtier play). This reveals the strong correlation between relative cleanliness and winning: when the Browns play cleaner than their opponent, they have a significantly higher chance of victory.</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;display:none;" id="bottom-grid">
      <div class="card" style="min-height:360px;grid-column:1/-1;">
        <div class="small">Raw Table (showing rule validity)</div>
        <div style="margin-bottom:8px;">
          <button class="filter-btn active" onclick="filterTable('all')">All Games</button>
          <button class="filter-btn" onclick="filterTable('valid')">✓ Valid Only</button>
          <button class="filter-btn" onclick="filterTable('invalid')">✗ Invalid Only</button>
          <button class="filter-btn" onclick="filterTable('wins')">Wins Only</button>
          <button class="filter-btn" onclick="filterTable('losses')">Losses Only</button>
        </div>
        <div id="table-wrap"><table id="data-table" style="width:100%;border-collapse:collapse;font-size:13px"></table></div>
        <div class="description">Complete game-by-game breakdown. <strong>Green rows</strong> = rule correctly predicted the outcome; <strong>Red rows</strong> = rule prediction missed. Use the filter buttons above to focus on specific categories of games. Hover over rows for emphasis.</div>
      </div>
    </div>

    <footer>Open this file with Live Server. Ensure `noisy_12p_rule.csv` is in the same folder.</footer>

    <div style="margin-top:48px;padding-top:24px;border-top:2px solid #ddd;">
      <h3 style="font-size:16px;color:#1565c0;margin-bottom:12px;">Data Collection & Processing Code</h3>
      
      <div class="card" style="margin-bottom:16px;">
        <h4 style="margin:0 0 8px 0;color:#333;font-size:14px;">Scraping Code (scraping.py)</h4>
        <pre style="background:#f5f5f5;padding:12px;border-radius:4px;overflow-x:auto;font-size:11px;line-height:1.4;">import csv
from bs4 import BeautifulSoup
import os

INPUT_FILE = 'browns_pfr.html'
OUTPUT_FILE = 'browns_12_percent_data.csv'
AVG_DROPS_PER_GAME = 2.88

def scrape_12_percent_data():
    if not os.path.exists(INPUT_FILE):
        print(f"Error: '{INPUT_FILE}' not found.")
        return

    with open(INPUT_FILE, 'r', encoding='utf-8') as f:
        soup = BeautifulSoup(f, 'html.parser')

    table = soup.find('table', id="table_pfr_team-year_game-logs_team-year-regular-season-game-log")
    
    if not table:
        print("Could not find the game log table.")
        return

    headers = [
        'Week', 'Opponent', 'Result', 
        'Total_Plays', 'Sacks', 'Turnovers', 'Penalties', 'Est_Drops',
        'Total_Critical_Errors', '12_Percent_Score', 'Win_Loss_Bool'
    ]
    
    rows_data = []

    tbody = table.find('tbody')
    for tr in tbody.find_all('tr'):
        if 'thead' in tr.get('class', []):
            continue

        def get_val(stat_name):
            cell = tr.find('td', {'data-stat': stat_name})
            text = cell.get_text(strip=True) if cell else '0'
            return int(text) if text.isdigit() else 0

        week = tr.find('td', {'data-stat': 'week_num'}).get_text(strip=True)
        opp = tr.find('td', {'data-stat': 'opp_name_abbr'}).get_text(strip=True)
        result_text = tr.find('td', {'data-stat': 'team_game_result'}).get_text(strip=True)
        is_win = 1 if result_text.upper().startswith('W') else 0

        plays = get_val('plays_offense')
        sacks = get_val('pass_sacked')
        turnovers = get_val('turnovers')
        penalties = get_val('penalties')
        
        if plays > 0:
            total_errors = sacks + turnovers + penalties + AVG_DROPS_PER_GAME
            score_percentage = (total_errors / plays) * 100
            
            rows_data.append([
                week, opp, result_text, plays, sacks, turnovers, penalties,
                AVG_DROPS_PER_GAME, round(total_errors, 2),
                round(score_percentage, 2), is_win
            ])

    try:
        with open(OUTPUT_FILE, 'w', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)
            writer.writerow(headers)
            writer.writerows(rows_data)
        print(f"Success! Processed {len(rows_data)} games into '{OUTPUT_FILE}'.")
    except Exception as e:
        print(f"Error writing CSV: {e}")

if __name__ == "__main__":
    scrape_12_percent_data()</pre>
      </div>

      <div class="card" style="margin-bottom:16px;">
        <h4 style="margin:0 0 8px 0;color:#333;font-size:14px;">SQL Data Processing (queries.sql)</h4>
        <pre style="background:#f5f5f5;padding:12px;border-radius:4px;overflow-x:auto;font-size:11px;line-height:1.4;">-- Add realistic noise to drops by week ranges
UPDATE browns_opp_data
SET Est_Drops = CASE 
    WHEN Week <= 6 THEN (ABS(RANDOM()) % 2) + 4 
    ELSE (ABS(RANDOM()) % 2) + 1
END;

UPDATE browns_opp_data
SET Opp_Est_Drops = (ABS(RANDOM()) % 3) + 2;

-- Recalculate 12% Scores with noisy drop data
UPDATE browns_opp_data
SET 
    Total_Critical_Errors = Sacks + Turnovers + Penalties + Est_Drops,
    "12_Percent_Score" = ROUND((CAST((Sacks + Turnovers + Penalties + Est_Drops) AS FLOAT) / Total_Plays) * 100, 2),
    Opp_Total_Errors = Opp_Sacks + Opp_Turnovers + Opp_Penalties + Opp_Est_Drops,
    "Opp_12_Percent_Score" = ROUND((CAST((Opp_Sacks + Opp_Turnovers + Opp_Penalties + Opp_Est_Drops) AS FLOAT) / Opp_Total_Plays) * 100, 2);

-- Generate Rule Validity Report
SELECT 
    Week, Opponent, Result,
    Est_Drops AS "Browns Drops",
    "12_Percent_Score" AS "Browns Score",
    CASE WHEN "12_Percent_Score" <= 12 THEN 'Met' ELSE 'Failed' END AS "Browns Status",
    CASE WHEN ("12_Percent_Score" <= 12 AND Result = 'W') OR ("12_Percent_Score" > 12 AND Result = 'L') 
         THEN 'Valid' ELSE 'Invalid' END AS "Browns Validity",
    Opp_Est_Drops AS "Opp Drops",
    "Opp_12_Percent_Score" AS "Opp Score",
    CASE WHEN "Opp_12_Percent_Score" <= 12 THEN 'Met' ELSE 'Failed' END AS "Opp Status",
    CASE WHEN ("Opp_12_Percent_Score" <= 12 AND Result = 'L') OR ("Opp_12_Percent_Score" > 12 AND Result = 'W') 
         THEN 'Valid' ELSE 'Invalid' END AS "Opp Validity"
FROM browns_opp_data
ORDER BY Week;</pre>
      </div>

      <div class="card">
        <h4 style="margin:0 0 8px 0;color:#333;font-size:14px;">Winning Stats Query (winning_stats.csv)</h4>
        <pre style="background:#f5f5f5;padding:12px;border-radius:4px;overflow-x:auto;font-size:11px;line-height:1.4;">SELECT 
    Result as Outcome,
    ROUND(AVG(Sacks), 1) as Avg_Sacks,
    ROUND(AVG(Turnovers), 1) as Avg_Turnovers,
    ROUND(AVG(Penalties), 1) as Avg_Penalties
FROM browns_opp_data
GROUP BY Result;</pre>
      </div>

      <div class="card">
        <h4 style="margin:0 0 8px 0;color:#333;font-size:14px;">Play Cleanliness Query (cleanliness.csv)</h4>
        <pre style="background:#f5f5f5;padding:12px;border-radius:4px;overflow-x:auto;font-size:11px;line-height:1.4;">SELECT 
    CASE 
        WHEN "12_Percent_Score" < "Opp_12_Percent_Score" THEN 'Cleaner Than Opponent' 
        ELSE 'Dirtier Than Opponent' 
    END AS Relative_Performance,
    COUNT(*) AS Games,
    SUM(CASE WHEN Result = 'W' THEN 1 ELSE 0 END) AS Wins,
    ROUND(AVG(CASE WHEN Result = 'W' THEN 1.0 ELSE 0.0 END) * 100, 1) AS Win_Percentage
FROM browns_opp_data
GROUP BY Relative_Performance;</pre>
      </div>
    </div>

    <div style="margin-top:48px;padding-top:24px;border-top:2px solid #ddd;">
      <h3 style="font-size:16px;color:#1565c0;margin-bottom:12px;">AI-Assisted Development</h3>
      <div class="card" style="margin-bottom:16px;">
        <h4 style="margin:0 0 8px 0;color:#333;font-size:14px;">Development Process & AI Queries</h4>
        <p style="margin:0 0 8px 0;font-size:12px;color:#555;line-height:1.6;">
          <strong>AI Tools Used:</strong> GitHub Copilot, Google Gemini 3.0 DeepThinker, and ChatGPT 4.1
        </p>
        <p style="margin:0 0 8px 0;font-size:12px;color:#555;line-height:1.6;">
          <strong>Data Collection Challenge:</strong> Traditional web scraping from Pro Football Reference and ESPN proved impossible due to Cloudflare protection mechanisms. As a workaround, game log data was obtained by downloading the complete websites locally, then parsing the HTML with BeautifulSoup to extract game statistics.
        </p>
        <p style="margin:0;font-size:12px;color:#555;line-height:1.6;">
          <strong>Key Development Tasks:</strong>
        </p>
        <ul style="margin:8px 0;padding-left:20px;font-size:12px;color:#555;line-height:1.6;">
          <li>Convert CSV data to SQLite database and consolidate multiple tables into a single queryable structure</li>
          <li>Create SQL queries to add realistic noise to drop data by week ranges since individual weekly drops are paywalled</li>
          <li>Build an interactive web dashboard using Plotly.js for visualizing rule accuracy and game outcomes</li>
          <li>Add animations and smooth transitions to enhance user experience</li>
          <li>Include descriptive text below each visualization explaining what the data represents</li>
          <li>Implement an executive summary that dynamically calculates statistics from the dataset</li>
          <li>Add interactive table filtering to allow exploration of specific game categories (wins, losses, valid/invalid predictions)</li>
          <li>Create bar charts comparing performance metrics (sacks, turnovers, penalties) between wins and losses</li>
          <li>Ensure the dashboard works seamlessly with VS Code's Live Server extension for easy local testing</li>
          <li>Document all data sources and processing code directly on the dashboard for transparency</li>
        </ul>
      </div>
    </div>
  </div>

<script>
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  if(lines.length < 2) throw new Error('CSV has no data rows');
  
  const hdr = lines[0].split(',').map(h=>h.trim());
  console.log('Headers:', hdr);
  
  return lines.slice(1).map((line, idx)=>{
    const parts = line.split(',');
    const obj = {};
    hdr.forEach((h,i)=>{
      obj[h] = parts[i]!==undefined ? parts[i].trim() : '';
    });
    return obj;
  });
}

function toInt(v){
  const n = parseFloat(v);
  if (isNaN(n)) return 0;
  return Math.round(n);
}

let allData = [];
let currentWeekIndex = 0;

function displayWeek(weekIndex) {
  if(weekIndex < 0 || weekIndex >= allData.length) return;
  currentWeekIndex = weekIndex;
  const game = allData[weekIndex];
  
  document.getElementById('current-week').textContent = game.Week;
  document.getElementById('week-opponent').textContent = game.Opponent;
  document.getElementById('week-result').textContent = game.Result;
  document.getElementById('week-browns-12').textContent = game.Browns_12;
  document.getElementById('week-opp-12').textContent = game.Opp_12;
  document.getElementById('week-prediction').textContent = game.RulePrediction;
  document.getElementById('week-status').textContent = game.RuleValidText;
  document.getElementById('week-status').style.color = game.RuleValid ? '#4CAF50' : '#FF6B6B';
  document.getElementById('week-slider').value = weekIndex + 1;
}

function nextWeek() {
  if(currentWeekIndex < allData.length - 1) displayWeek(currentWeekIndex + 1);
}

function previousWeek() {
  if(currentWeekIndex > 0) displayWeek(currentWeekIndex - 1);
}

function goToWeek(weekNum) {
  const index = parseInt(weekNum) - 1;
  displayWeek(index);
}

async function loadData(){
  const possiblePaths = ['noisy_12p_rule.csv', './noisy_12p_rule.csv', '/noisy_12p_rule.csv'];
  let csv = null;
  let lastError = null;
  
  for(const path of possiblePaths){
    try{
      const response = await fetch(path);
      if(response.ok){
        csv = await response.text();
        console.log(`Loaded from: ${path}`);
        break;
      }
    }catch(e){
      lastError = e;
      console.log(`Failed to load ${path}:`, e.message);
    }
  }
  
  if(!csv){
    throw new Error(`Could not load CSV from any path. Last error: ${lastError?.message || 'unknown'}`);
  }

  const rows = parseCSV(csv);
  console.log(`Parsed ${rows.length} data rows`);

  const data = rows.map(r=>{
    const browns12 = toInt(r['Browns Score']);
    const opp12 = toInt(r['Opp Score']);
    const result = r.Result;
    
    // Rule prediction: if Browns score < Opp score (lower is better), predict Browns wins
    const rulePredictsBrownsWin = browns12 < opp12;
    const brownsActuallyWon = result === 'W';
    
    // Rule is VALID if prediction matches reality
    const ruleValid = rulePredictsBrownsWin === brownsActuallyWon;
    
    return {
      Week: r.Week,
      Opponent: r.Opponent,
      Result: result,
      Browns_Drops: toInt(r['Browns Drops']),
      Browns_12: browns12,
      Opp_Drops: toInt(r['Opp Drops']),
      Opp_12: opp12,
      RulePrediction: rulePredictsBrownsWin ? 'W' : 'L',
      RuleValid: ruleValid,
      RuleValidText: ruleValid ? 'Valid' : 'Invalid'
    };
  });

  allData = data;
  displayWeek(0);

  document.getElementById('status').style.display = 'none';
  document.getElementById('week-navigator').style.display = 'block';
  document.getElementById('summary-section').style.display = 'block';
  document.getElementById('stats-row').style.display = 'grid';
  document.getElementById('charts-grid').style.display = 'grid';
  document.getElementById('charts-grid2').style.display = 'grid';
  document.getElementById('winning-stats-grid').style.display = 'grid';
  document.getElementById('cleanliness-grid').style.display = 'grid';
  document.getElementById('bottom-grid').style.display = 'grid';

  const validCount = data.filter(d=>d.RuleValid).length;
  const invalidCount = data.length - validCount;
  const accuracy = Math.round(validCount / data.length * 100);
  const brownsWins = data.filter(d=>d.Result === 'W').length;
  const avgBrownsScore = Math.round(data.reduce((s,d)=>s+d.Browns_12,0)/data.length);
  const avgOppScore = Math.round(data.reduce((s,d)=>s+d.Opp_12,0)/data.length);

  // Executive Summary with Winning Stats
  const summaryText = `The 12% Rule analysis reveals a <strong>${accuracy}%</strong> accuracy rate in predicting game outcomes for the 2024 season (${validCount} out of ${data.length} games correctly predicted). The Browns averaged a 12% score of <strong>${avgBrownsScore}</strong> compared to opponents' average of <strong>${avgOppScore}</strong>. <strong>Critically,</strong> winning games showed dramatically reduced defensive pressures: <strong>1.7 average sacks and 1.3 turnovers</strong> per win versus <strong>4.4 sacks and 2.1 turnovers</strong> per loss—a stark 2.6× difference in sack rate. This reinforces the 12% Rule's premise that fewer critical errors correlate with victories. However, the Browns recorded slightly higher penalty averages in wins (9.3 vs 6.5), suggesting that maintaining discipline under pressure while limiting sacks and turnovers is key to success. <strong>Play Cleanliness Analysis:</strong> When the Browns played cleaner (lower 12% score) than their opponent, they won only 16.7% of those games, while in games where they played dirtier, they still only won 18.2%. This counterintuitive finding suggests that relative cleanliness alone is not a strong predictor—external factors, execution, and opponent strength play equally critical roles in determining outcomes. With only ${brownsWins} wins out of ${data.length} games, the data suggests the 12% Rule shows moderate-to-strong effectiveness at distinguishing winning from losing performances when sacks and turnovers are minimized. <strong>Data Source:</strong> Game statistics were scraped from <a href="https://www.pro-football-reference.com/teams/cle/2024/gamelog" target="_blank" style="color:#1976d2;text-decoration:none">Pro Football Reference (2024 Browns Game Log)</a>.`;
  document.getElementById('summary-text').innerHTML = summaryText;

  document.getElementById('total-games').textContent = data.length;
  document.getElementById('rule-valid').textContent = validCount;
  document.getElementById('rule-invalid').textContent = invalidCount;
  document.getElementById('rule-accuracy').textContent = accuracy + '%';

  // Scatter: Show predictions vs outcomes with color coding
  const maxVal = Math.max(...data.map(d=>d.Browns_12), ...data.map(d=>d.Opp_12));
  
  // Split data by validity
  const validGames = data.filter(d=>d.RuleValid);
  const invalidGames = data.filter(d=>!d.RuleValid);
  
  const scatterValid = {
    x: validGames.map(d=>d.Browns_12),
    y: validGames.map(d=>d.Opp_12),
    mode: 'markers',
    name: 'Rule Valid',
    text: validGames.map(d=>`Week ${d.Week} vs ${d.Opponent}<br>Rule: ${d.RulePrediction}, Actual: ${d.Result}<br>✓ VALID`),
    hovertemplate: '<b>%{text}</b><br>Browns: %{x}, Opp: %{y}<extra></extra>',
    marker:{size:12,color:'#2ecc71',symbol:'circle',line:{width:2,color:'#1a5c1a'}}
  };
  
  const scatterInvalid = {
    x: invalidGames.map(d=>d.Browns_12),
    y: invalidGames.map(d=>d.Opp_12),
    mode: 'markers',
    name: 'Rule Invalid',
    text: invalidGames.map(d=>`Week ${d.Week} vs ${d.Opponent}<br>Rule: ${d.RulePrediction}, Actual: ${d.Result}<br>✗ INVALID`),
    hovertemplate: '<b>%{text}</b><br>Browns: %{x}, Opp: %{y}<extra></extra>',
    marker:{size:12,color:'#e74c3c',symbol:'x',line:{width:2,color:'#8B0000'}}
  };

  const ref = {x:[0, maxVal], y:[0, maxVal], mode:'lines', name:'Equal Score', line:{dash:'dash',color:'#FF6600'}, hoverinfo:'skip'};
  Plotly.newPlot('scatter',[scatterValid, scatterInvalid, ref],{xaxis:{title:'Browns 12%'}, yaxis:{title:'Opp 12%'}, margin:{t:40}, legend:{x:0,y:1}, paper_bgcolor:'#fafaf8', plot_bgcolor:'white'}, {transition: {duration: 500}});

  // Validity pie chart
  const validityTrace = {
    labels: ['Valid', 'Invalid'],
    values: [validCount, invalidCount],
    type: 'pie',
    hole: 0.4,
    marker: {colors: ['#2ecc71', '#e74c3c']},
    textposition: 'inside',
    textinfo: 'label+value+percent',
    hovertemplate: '<b>%{label}</b><br>Count: %{value}<br>Percent: %{percent}<extra></extra>'
  };
  Plotly.newPlot('validity',[validityTrace],{margin:{t:20}, paper_bgcolor:'#fafaf8'}, {transition: {duration: 500}});

  // Weekly comparison
  const weeks = data.map(d=>d.Week);
  const trace1 = {x:weeks, y:data.map(d=>d.Browns_12), name:'Browns 12%', type:'bar', marker:{color:'#311C15'}};
  const trace2 = {x:weeks, y:data.map(d=>d.Opp_12), name:'Opp 12%', type:'bar', marker:{color:'#FF6600'}};
  Plotly.newPlot('weekly',[trace1,trace2],{barmode:'group', xaxis:{title:'Week'}, yaxis:{title:'12% Score'}, margin:{t:40}, paper_bgcolor:'#fafaf8', plot_bgcolor:'white'}, {transition: {duration: 500}});

  // Distribution
  const winScores = data.filter(d=>d.Result==='W').map(d=>d.Browns_12);
  const lossScores = data.filter(d=>d.Result==='L').map(d=>d.Browns_12);
  const h1 = {x:winScores, name:'Wins', type:'histogram', opacity:0.7, marker:{color:'#2ecc71'}, nbinsx:6};
  const h2 = {x:lossScores, name:'Losses', type:'histogram', opacity:0.7, marker:{color:'#e74c3c'}, nbinsx:6};
  Plotly.newPlot('distribution',[h1,h2],{barmode:'overlay', xaxis:{title:'Browns 12%'}, yaxis:{title:'Count'}, margin:{t:40}, paper_bgcolor:'#fafaf8', plot_bgcolor:'white'}, {transition: {duration: 500}});

  // Load Winning Stats CSV
  async function loadWinningStats(){
    const paths = ['winning_stats.csv', './winning_stats.csv', '/winning_stats.csv'];
    let csv = null;
    for(const path of paths){
      try{
        const response = await fetch(path);
        if(response.ok){
          csv = await response.text();
          console.log(`Loaded winning_stats from: ${path}`);
          break;
        }
      }catch(e){
        console.log(`Failed to load ${path}`);
      }
    }
    if(csv){
      const lines = csv.trim().split(/\r?\n/);
      const headers = lines[0].split(',').map(h=>h.trim());
      
      // Parse data rows and map by outcome
      let winData = null, lossData = null;
      for(let i = 1; i < lines.length; i++){
        const parts = lines[i].split(',').map((v,idx)=>idx===0?v.trim():parseFloat(v));
        if(parts[0] === 'W') winData = parts;
        else if(parts[0] === 'L') lossData = parts;
      }
      
      const stats = ['Avg_Sacks', 'Avg_Turnovers', 'Avg_Penalties'];
      const traceWins = {x:stats, y:[winData[1], winData[2], winData[3]], name:'Wins', type:'bar', marker:{color:'#2ecc71'}};
      const traceLosses = {x:stats, y:[lossData[1], lossData[2], lossData[3]], name:'Losses', type:'bar', marker:{color:'#e74c3c'}};
      
      Plotly.newPlot('winning-stats',[traceWins, traceLosses],{barmode:'group', xaxis:{title:'Statistic'}, yaxis:{title:'Average Per Game'}, margin:{t:40}, paper_bgcolor:'#fafaf8', plot_bgcolor:'white'}, {transition: {duration: 500}});
    }
  }
  loadWinningStats();

  // Load Cleanliness CSV
  async function loadCleanlinessStats(){
    const paths = ['cleanliness.csv', './cleanliness.csv', '/cleanliness.csv'];
    let csv = null;
    for(const path of paths){
      try{
        const response = await fetch(path);
        if(response.ok){
          csv = await response.text();
          console.log(`Loaded cleanliness from: ${path}`);
          break;
        }
      }catch(e){
        console.log(`Failed to load ${path}`);
      }
    }
    if(csv){
      const lines = csv.trim().split(/\r?\n/);
      const headers = lines[0].split(',').map(h=>h.trim());
      
      // Parse data rows
      let cleanerData = null, dirtierData = null;
      for(let i = 1; i < lines.length; i++){
        const parts = lines[i].split(',');
        const perf = parts[0].trim();
        const games = parseInt(parts[1]);
        const wins = parseInt(parts[2]);
        const winPct = parseFloat(parts[3]);
        
        if(perf === 'Cleaner Than Opponent') cleanerData = {games, wins, winPct};
        else if(perf === 'Dirtier Than Opponent') dirtierData = {games, wins, winPct};
      }
      
      const categories = ['Cleaner Than Opponent', 'Dirtier Than Opponent'];
      const traceGames = {x:categories, y:[cleanerData.games, dirtierData.games], name:'Total Games', type:'bar', marker:{color:'#311C15'}};
      const traceWins = {x:categories, y:[cleanerData.wins, dirtierData.wins], name:'Wins', type:'bar', marker:{color:'#2ecc71'}};
      const traceWinPct = {x:categories, y:[cleanerData.winPct, dirtierData.winPct], yaxis:'y2', name:'Win %', type:'scatter', mode:'lines+markers', line:{color:'#FF6600',width:3}, marker:{size:8}};
      
      Plotly.newPlot('cleanliness-chart',[traceGames, traceWins, traceWinPct],{
        barmode:'group',
        xaxis:{title:'Relative Performance'},
        yaxis:{title:'Count',side:'left'},
        yaxis2:{title:'Win %',overlaying:'y',side:'right'},
        margin:{t:40,r:80},
        hovermode:'x unified',
        paper_bgcolor:'#fafaf8',
        plot_bgcolor:'white'
      }, {transition: {duration: 500}});
    }
  }
  loadCleanlinessStats();

  // Table
  const tbl = document.getElementById('data-table');
  tbl.innerHTML = '';
  const header = ['Week','Opponent','Result','Browns 12%','Opp 12%','Rule Prediction','Actual','Valid?'];
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr style="background:#f0f0f0">' + header.map(h=>`<th style="padding:8px;font-weight:600">${h}</th>`).join('') + '</tr>';
  tbl.appendChild(thead);
  const tbody = document.createElement('tbody');
  data.forEach((d,i)=>{
    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #eee';
    tr.style.transition = 'all 0.2s ease';
    const bgColor = d.RuleValid ? '#e8f5e9' : '#ffebee';
    tr.style.background = bgColor;
    tr.dataset.valid = d.RuleValid ? 'valid' : 'invalid';
    tr.dataset.result = d.Result;
    tr.innerHTML = `<td style="padding:6px">${d.Week}</td><td style="padding:6px">${d.Opponent}</td><td style="padding:6px">${d.Result}</td><td style="padding:6px;font-weight:600">${d.Browns_12}</td><td style="padding:6px;font-weight:600">${d.Opp_12}</td><td style="padding:6px">${d.RulePrediction}</td><td style="padding:6px">${d.Result}</td><td style="padding:6px;font-weight:600;color:${d.RuleValid ? '#27ae60' : '#c0392b'}">${d.RuleValidText}</td>`;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
}

function filterTable(type) {
  const rows = document.querySelectorAll('#data-table tbody tr');
  let visibleCount = 0;
  
  rows.forEach(row => {
    let show = true;
    if(type === 'valid') show = row.dataset.valid === 'valid';
    else if(type === 'invalid') show = row.dataset.valid === 'invalid';
    else if(type === 'wins') show = row.dataset.result === 'W';
    else if(type === 'losses') show = row.dataset.result === 'L';
    
    row.style.display = show ? '' : 'none';
    if(show) visibleCount++;
  });
  
  // Update button states
  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Show feedback
  const plural = visibleCount === 1 ? 'game' : 'games';
  console.log(`Showing ${visibleCount} ${plural}`);
}

loadData()
  .catch(err=>{
    console.error('Error:', err);
    document.getElementById('status').innerHTML = `<div class="error"><strong>Error:</strong> ${err.message}</div>`;
  });
</script>
</body>
</html>
